---
import "../styles/global.css";
import BrandIcon from "../components/BrandIcon.astro";

interface Props {
  title?: string;
  description?: string;
  showSectionLinks?: boolean;
}

const {
  title = "Nguy·ªÖn ƒê·ª©c M·∫°nh ‚Äî Senior Software Engineer",
  description = "Personal website of Nguy·ªÖn ƒê·ª©c M·∫°nh, a senior software engineer in Hanoi, Vietnam ‚Äî 7+ years building scalable systems powering millions of users.",
  showSectionLinks = true,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <script is:inline>
      (() => {
        const saved = localStorage.getItem("theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const theme = saved || (systemPrefersDark ? "dark" : "light");
        document.documentElement.dataset.theme = theme;
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="theme-color" id="meta-theme-color" content="#1e1e2e" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap"
      rel="stylesheet"
    />
    <title>{title}</title>
  </head>
  <body class="loader-active">
    <div class="page-loader" id="page-loader" aria-live="polite" role="status">
      <div class="page-loader-card">
        <div class="page-loader-icon" aria-hidden="true">
          <BrandIcon label="Linux" size={34} />
        </div>
        <p class="page-loader-label">Booting ...</p>
      </div>
    </div>

    <div class="noise-overlay"></div>
    <div class="cursor-glow" id="cursor-glow"></div>

    <nav class="nav" id="nav">
      <div class="nav-inner">
        <a href="#top" class="nav-logo">
          <span class="logo-prefix">{}</span>
          <span class="logo-text">MAX</span>
        </a>
        <div class="nav-links" id="nav-links">
          {
            showSectionLinks ? (
              <>
                <a href="#about" data-section="about">
                  About
                </a>
                <a href="#expertise" data-section="expertise">
                  Expertise
                </a>
                <a href="#architecture" data-section="architecture">
                  Architecture
                </a>
                <a href="#devops" data-section="devops">
                  DevOps
                </a>
                <a href="#experience" data-section="experience">
                  Experience
                </a>
                <a href="#stack" data-section="stack">
                  Stack
                </a>
                <a href="#links" data-section="links">
                  Links
                </a>
                <a href="#contact" data-section="contact">
                  Contact
                </a>
                <a href="/maxos" data-section="contact">
                  maxOS
                </a>
              </>
            ) : (
              <a href="/" data-section="home">
                Home
              </a>
            )
          }
        </div>
        <div class="nav-actions">
          <button
            class="mobile-menu-toggle"
            id="mobile-menu-toggle"
            type="button"
            aria-label="Toggle menu"
            aria-controls="nav-links"
            aria-expanded="false"
          >
            <span class="mobile-menu-lines" aria-hidden="true">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
          <button
            class="theme-toggle"
            id="theme-toggle"
            type="button"
            aria-label="Switch to light theme"
            title="Toggle theme"
          >
            <span class="theme-icon" id="theme-icon">üåô</span>
          </button>
        </div>
      </div>
    </nav>

    <main>
      <slot />
    </main>

    <footer class="footer">
      <div class="footer-inner animate-on-scroll">
        <p class="footer-sub">
          &copy; {new Date().getFullYear()} Nguy·ªÖn ƒê·ª©c M·∫°nh. All rights reserved.
        </p>
      </div>
    </footer>

    <script>
      // Initial loading screen
      const pageLoader = document.getElementById("page-loader");
      const hideLoader = () => {
        if (!pageLoader || pageLoader.classList.contains("is-hidden")) return;
        pageLoader.classList.add("is-hidden");
        document.body.classList.remove("loader-active");
        window.setTimeout(() => pageLoader.remove(), 450);
      };

      if (document.readyState === "complete") {
        hideLoader();
      } else {
        window.addEventListener(
          "load",
          () => {
            window.setTimeout(hideLoader, 220);
          },
          { once: true },
        );
        // Fallback in case load is delayed by third-party resources
        window.setTimeout(hideLoader, 2600);
      }

      const animTargets =
        ".animate-on-scroll, .animate-slide-left, .animate-slide-right, .animate-scale";

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
            }
          });
        },
        { threshold: 0.08, rootMargin: "0px 0px -40px 0px" },
      );

      document
        .querySelectorAll(animTargets)
        .forEach((el) => observer.observe(el));

      // Nav scroll effect
      const nav = document.getElementById("nav")!;
      const mobileMenuToggle = document.getElementById(
        "mobile-menu-toggle",
      ) as HTMLButtonElement | null;
      window.addEventListener(
        "scroll",
        () => {
          nav.classList.toggle("nav-scrolled", window.scrollY > 80);
        },
        { passive: true },
      );

      // Active nav link tracking
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll<HTMLAnchorElement>(
        ".nav-links a[data-section]",
      );
      const closeMobileMenu = () => {
        nav.classList.remove("nav-menu-open");
        mobileMenuToggle?.setAttribute("aria-expanded", "false");
      };

      mobileMenuToggle?.addEventListener("click", () => {
        const nextOpen = !nav.classList.contains("nav-menu-open");
        nav.classList.toggle("nav-menu-open", nextOpen);
        mobileMenuToggle.setAttribute("aria-expanded", String(nextOpen));
      });

      navLinks.forEach((link) => {
        link.addEventListener("click", closeMobileMenu);
      });

      document.addEventListener("click", (e) => {
        if (!nav.contains(e.target as Node)) {
          closeMobileMenu();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeMobileMenu();
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 860) closeMobileMenu();
      });

      const sectionObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute("id");
              navLinks.forEach((link) => {
                link.classList.toggle("active", link.dataset.section === id);
              });
            }
          });
        },
        { threshold: 0.3, rootMargin: "-80px 0px -40% 0px" },
      );

      sections.forEach((s) => sectionObserver.observe(s));

      // Smooth scroll
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", (e) => {
          e.preventDefault();
          const href = (e.currentTarget as HTMLAnchorElement).getAttribute(
            "href",
          );
          if (href) {
            const target = document.querySelector(href);
            target?.scrollIntoView({ behavior: "smooth" });
          }
        });
      });

      // Cursor glow
      const glow = document.getElementById("cursor-glow");
      if (glow && window.matchMedia("(pointer: fine)").matches) {
        document.addEventListener(
          "mousemove",
          (e) => {
            glow.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
            glow.style.opacity = "1";
          },
          { passive: true },
        );

        document.addEventListener("mouseleave", () => {
          glow.style.opacity = "0";
        });
      }

      // Theme toggle
      const themeToggle = document.getElementById("theme-toggle");
      const themeIcon = document.getElementById("theme-icon");
      const metaThemeColor = document.getElementById("meta-theme-color");
      const darkThemeColor = "#1e1e2e";
      const lightThemeColor = "#eff1f5";

      const syncThemeUI = (theme: string) => {
        const isDark = theme === "dark";
        if (themeIcon) {
          themeIcon.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
        }
        if (themeToggle) {
          themeToggle.setAttribute(
            "aria-label",
            isDark ? "Switch to light theme" : "Switch to dark theme",
          );
        }
        if (metaThemeColor) {
          metaThemeColor.setAttribute(
            "content",
            isDark ? darkThemeColor : lightThemeColor,
          );
        }
      };

      const initialTheme =
        document.documentElement.dataset.theme === "light" ? "light" : "dark";
      syncThemeUI(initialTheme);

      themeToggle?.addEventListener("click", () => {
        const nextTheme =
          document.documentElement.dataset.theme === "dark" ? "light" : "dark";
        document.documentElement.dataset.theme = nextTheme;
        localStorage.setItem("theme", nextTheme);
        syncThemeUI(nextTheme);
      });
    </script>

    <style>
      .loader-active {
        overflow: hidden;
      }

      .page-loader {
        position: fixed;
        inset: 0;
        z-index: 10001;
        display: grid;
        place-items: center;
        background: color-mix(in srgb, var(--ctp-base) 80%, transparent);
        backdrop-filter: blur(12px) saturate(130%);
        -webkit-backdrop-filter: blur(12px) saturate(130%);
        transition:
          opacity 0.35s ease,
          visibility 0.35s ease;
      }

      .page-loader.is-hidden {
        opacity: 0;
        visibility: hidden;
      }

      .page-loader-card {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        padding: 0.7rem 1rem;
        border-radius: 999px;
        border: 1px solid var(--surface-border);
        background: var(--surface-card-strong);
        box-shadow: var(--surface-shadow);
        backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate))
          brightness(var(--glass-brightness));
        -webkit-backdrop-filter: blur(var(--glass-blur))
          saturate(var(--glass-saturate)) brightness(var(--glass-brightness));
      }

      .page-loader-icon {
        width: 2.3rem;
        height: 2.3rem;
        border-radius: 999px;
        display: grid;
        place-items: center;
        color: var(--ctp-text);
        border: 1px solid var(--accent-blue-border);
        background: var(--accent-blue-bg);
        animation: loaderPulse 1.2s ease-in-out infinite;
      }

      .page-loader-label {
        font-family: var(--font-mono);
        font-size: 0.82rem;
        letter-spacing: 0.02em;
        color: var(--ctp-subtext0);
      }

      @keyframes loaderPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .noise-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        pointer-events: none;
        opacity: 0.015;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        background-repeat: repeat;
        background-size: 256px 256px;
      }

      .cursor-glow {
        position: fixed;
        top: -150px;
        left: -150px;
        width: 300px;
        height: 300px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(203, 166, 247, 0.04) 0%,
          transparent 70%
        );
        pointer-events: none;
        z-index: 9998;
        opacity: 0;
        transition: opacity 0.3s ease;
        will-change: transform;
      }

      .nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        padding: 1.25rem 2rem;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .nav-scrolled {
        background: var(--nav-scrolled-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--ctp-surface0);
        padding: 0.75rem 2rem;
      }

      .nav-inner {
        max-width: var(--max-width);
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        position: relative;
      }

      .nav-logo {
        font-family: var(--font-mono);
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--ctp-text);
        letter-spacing: -0.02em;
        display: inline-flex;
        align-items: center;
        gap: 0.28rem;
        transition: color 0.2s ease;
      }

      .nav-logo:hover {
        color: var(--ctp-mauve);
      }

      .logo-prefix {
        color: var(--ctp-mauve);
        font-weight: 400;
      }

      .logo-text {
        font-weight: 700;
      }

      .nav-links {
        display: flex;
        gap: 1.75rem;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 0.55rem;
      }

      .mobile-menu-toggle {
        display: none;
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 999px;
        border: 1px solid var(--ctp-surface1);
        background: var(--ctp-mantle);
        color: var(--ctp-text);
        place-items: center;
        cursor: pointer;
        transition:
          border-color 0.2s ease,
          transform 0.2s ease;
      }

      .mobile-menu-lines {
        position: relative;
        width: 1rem;
        height: 0.9rem;
      }

      .mobile-menu-lines span {
        position: absolute;
        left: 0;
        width: 100%;
        height: 2px;
        background: currentColor;
        border-radius: 2px;
        transition:
          transform 0.25s ease,
          opacity 0.2s ease,
          top 0.25s ease;
      }

      .mobile-menu-lines span:nth-child(1) {
        top: 0;
      }
      .mobile-menu-lines span:nth-child(2) {
        top: 0.35rem;
      }
      .mobile-menu-lines span:nth-child(3) {
        top: 0.7rem;
      }

      .nav-menu-open .mobile-menu-lines span:nth-child(1) {
        top: 0.35rem;
        transform: rotate(45deg);
      }

      .nav-menu-open .mobile-menu-lines span:nth-child(2) {
        opacity: 0;
      }

      .nav-menu-open .mobile-menu-lines span:nth-child(3) {
        top: 0.35rem;
        transform: rotate(-45deg);
      }

      .theme-toggle {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 999px;
        border: 1px solid var(--ctp-surface1);
        background: var(--ctp-mantle);
        color: var(--ctp-text);
        display: grid;
        place-items: center;
        cursor: pointer;
        transition:
          border-color 0.2s ease,
          color 0.2s ease,
          transform 0.2s ease;
      }

      .theme-toggle:hover {
        border-color: var(--ctp-mauve);
        color: var(--ctp-mauve);
        transform: translateY(-1px);
      }

      .theme-icon {
        line-height: 1;
        font-size: 0.95rem;
      }

      .nav-links a {
        font-size: 0.875rem;
        color: var(--ctp-subtext0);
        font-weight: 500;
        transition: color 0.2s ease;
        position: relative;
        padding-bottom: 2px;
      }

      .nav-links a::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--ctp-mauve);
        border-radius: 1px;
        transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: var(--ctp-text);
      }

      .nav-links a:hover::after,
      .nav-links a.active::after {
        width: 100%;
      }

      .nav-links a.active {
        color: var(--ctp-mauve);
      }

      .footer {
        border-top: 1px solid var(--ctp-surface0);
        padding: 3rem 2rem;
        text-align: center;
      }

      .footer-inner {
        max-width: var(--max-width);
        margin: 0 auto;
      }

      .footer p {
        color: var(--ctp-overlay1);
        font-size: 0.875rem;
      }

      .footer-sub {
        margin-top: 0.5rem;
        font-size: 0.8rem !important;
        color: var(--ctp-overlay0) !important;
      }

      .heart {
        color: var(--ctp-red);
        display: inline-block;
        animation: heartbeat 1.5s ease-in-out infinite;
      }

      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        14% {
          transform: scale(1.15);
        }
        28% {
          transform: scale(1);
        }
        42% {
          transform: scale(1.1);
        }
        56% {
          transform: scale(1);
        }
      }

      .footer a {
        color: var(--ctp-mauve);
      }

      @media (max-width: 640px) {
        .theme-toggle {
          width: 2rem;
          height: 2rem;
        }
      }

      @media (max-width: 860px) {
        .nav {
          top: 0.35rem;
          left: 50%;
          right: auto;
          width: min(92vw, 560px);
          transform: translateX(-50%);
          padding: 0;
        }

        .nav-scrolled {
          background: transparent;
          border-bottom: none;
          padding: 0;
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }

        .nav-inner {
          padding: 0.48rem 0.6rem;
          border-radius: 18px;
          border: 1px solid var(--surface-border);
          background: color-mix(
            in srgb,
            var(--ctp-mantle) 92%,
            var(--ctp-base)
          );
          box-shadow: var(--surface-shadow);
          backdrop-filter: blur(var(--glass-blur))
            saturate(var(--glass-saturate)) brightness(var(--glass-brightness));
          -webkit-backdrop-filter: blur(var(--glass-blur))
            saturate(var(--glass-saturate)) brightness(var(--glass-brightness));
        }

        .nav-logo {
          display: none;
        }

        .mobile-menu-toggle {
          display: grid;
        }

        .nav-links {
          position: absolute;
          top: calc(100% + 0.6rem);
          left: 0;
          width: min(88vw, 320px);
          display: grid;
          gap: 0.2rem;
          padding: 0.5rem;
          border-radius: 14px;
          border: 1px solid var(--surface-border);
          background: color-mix(
            in srgb,
            var(--ctp-mantle) 94%,
            var(--ctp-base)
          );
          box-shadow: var(--surface-shadow);
          backdrop-filter: blur(calc(var(--glass-blur) * 0.95))
            saturate(var(--glass-saturate)) brightness(var(--glass-brightness));
          -webkit-backdrop-filter: blur(calc(var(--glass-blur) * 0.95))
            saturate(var(--glass-saturate)) brightness(var(--glass-brightness));
          opacity: 0;
          visibility: hidden;
          transform: translateY(-8px) scale(0.97);
          transform-origin: top left;
          transition:
            opacity 0.22s ease,
            transform 0.24s cubic-bezier(0.16, 1, 0.3, 1),
            visibility 0.22s ease;
          pointer-events: none;
        }

        .nav-menu-open .nav-links {
          opacity: 1;
          visibility: visible;
          transform: translateY(0) scale(1);
          pointer-events: auto;
        }

        .nav-links a {
          font-size: 0.92rem;
          padding: 0.62rem 0.75rem;
          border-radius: 10px;
          color: var(--ctp-subtext1);
          background: transparent;
        }

        .nav-links a::after {
          display: none;
        }

        .nav-links a:hover,
        .nav-links a.active {
          color: var(--ctp-text);
          background: var(--accent-mauve-bg);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .page-loader-icon {
          animation: none;
        }
      }
    </style>
  </body>
</html>
